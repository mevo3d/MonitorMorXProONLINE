<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor X Morelos - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .header { background: #1a237e; color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header .status { font-size: 0.9rem; opacity: 0.8; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card h3 { color: #333; margin-bottom: 1rem; font-size: 1.1rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #1a237e; margin-bottom: 0.5rem; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .service-status { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .status-active { background: #4caf50; }
        .status-inactive { background: #f44336; }
        .status-warning { background: #ff9800; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .error { text-align: center; padding: 2rem; color: #f44336; }
        .refresh-btn { background: #1a237e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #303f9f; }
        #lastUpdate { font-size: 0.8rem; color: #666; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Monitor X Morelos v2.0</h1>
        <div class="status" id="systemStatus">Cargando estado del sistema...</div>
    </div>

    <div class="container">
        <div class="loading" id="loading">Cargando dashboard...</div>
        <div id="dashboard" style="display: none;">
            <div class="grid">
                <!-- Estad√≠sticas Generales -->
                <div class="card">
                    <h3>üìä Publicaciones (24h)</h3>
                    <div class="stat-value" id="totalPublicaciones">-</div>
                    <div class="stat-label">Total monitoreadas</div>
                </div>

                <div class="card">
                    <h3>üö® Alertas Urgentes</h3>
                    <div class="stat-value" id="alertasUrgentes">-</div>
                    <div class="stat-label">Necesitan atenci√≥n</div>
                </div>

                <div class="card">
                    <h3>üòä Sentimiento General</h3>
                    <div class="stat-value" id="sentimientoGeneral">-</div>
                    <div class="stat-label">Promedio del d√≠a</div>
                </div>

                <div class="card">
                    <h3>üîë Palabras Clave</h3>
                    <div class="stat-value" id="totalKeywords">-</div>
                    <div class="stat-label">Activas</div>
                </div>
            </div>

            <!-- Estado de Servicios -->
            <div class="card">
                <h3>üîß Estado de Servicios</h3>
                <div id="serviciosStatus">
                    <div class="loading">Cargando estado de servicios...</div>
                </div>
            </div>

            <!-- Estad√≠sticas por Plataforma -->
            <div class="card">
                <h3>üìà Actividad por Plataforma</h3>
                <div id="plataformaStats">
                    <div class="loading">Cargando estad√≠sticas...</div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ Actualizar</button>
                <div id="lastUpdate"></div>
            </div>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            try {
                // Cargar estado general
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();

                // Cargar estad√≠sticas
                const statsResponse = await fetch('/api/estadisticas');
                const stats = await statsResponse.data;

                // Cargar keywords
                const keywordsResponse = await fetch('/api/keywords');
                const keywords = await keywordsResponse.data;

                // Actualizar dashboard
                updateDashboard(status, stats, keywords);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('lastUpdate').textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleString('es-MX');

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                document.getElementById('loading').innerHTML = '<div class="error">Error cargando el dashboard</div>';
            }
        }

        function updateDashboard(status, stats, keywords) {
            // Actualizar estado del sistema
            document.getElementById('systemStatus').textContent =
                status.status === 'online' ? '‚úÖ Sistema en l√≠nea' : '‚ùå Sistema con problemas';

            // Actualizar estad√≠sticas generales
            const totalPub = stats.porPlataforma.reduce((sum, p) => sum + parseInt(p.total), 0);
            document.getElementById('totalPublicaciones').textContent = totalPub;
            document.getElementById('alertasUrgentes').textContent = stats.urgentes;
            document.getElementById('sentimientoGeneral').textContent =
                stats.sentimiento.promedio.toFixed(2);
            document.getElementById('totalKeywords').textContent = keywords.total;

            // Actualizar estado de servicios
            const serviciosHtml = Object.entries(status.services).map(([service, estado]) => {
                const statusClass = estado === 'active' ? 'status-active' :
                                   estado === 'starting' ? 'status-warning' : 'status-inactive';
                const serviceNames = {
                    x_monitor: 'X Monitor',
                    facebook_monitor: 'Facebook Monitor',
                    youtube_monitor: 'YouTube Monitor',
                    rss_monitor: 'RSS Monitor',
                    telegram_notifier: 'Telegram Notifier'
                };
                return `
                    <div class="service-status">
                        <div class="status-dot ${statusClass}"></div>
                        <span>${serviceNames[service] || service}: ${estado}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('serviciosStatus').innerHTML = serviciosHtml;

            // Actualizar estad√≠sticas por plataforma
            const plataformaStats = stats.porPlataforma.map(p => {
                const iconos = { x: 'üê¶', facebook: 'üìò', youtube: 'üì∫', rss: 'üì∞' };
                const icono = iconos[p.plataforma] || 'üì¢';
                return `
                    <div class="service-status">
                        <span>${icono} ${p.plataforma.toUpperCase()}: <strong>${p.total}</strong> publicaciones</span>
                    </div>
                `;
            }).join('');
            document.getElementById('plataformaStats').innerHTML = plataformaStats || '<div class="loading">No hay actividad reciente</div>';
        }

        // Cargar dashboard al iniciar
        loadDashboard();

        // Auto-refrescar cada 30 segundos
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>